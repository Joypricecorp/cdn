/**
 * @author Nicolas Ferrero
 * A TabPanel with grouping support.
 */Ext.define("Ext.ux.GroupTabPanel",{extend:"Ext.Container",alias:"widget.grouptabpanel",requires:["Ext.tree.Panel","Ext.ux.GroupTabRenderer"],baseCls:Ext.baseCSSPrefix+"grouptabpanel",initComponent:function(e){var t=this;Ext.apply(t,e);t.store=t.createTreeStore();t.layout={type:"hbox",align:"stretch"};t.defaults={border:!1};t.items=[{xtype:"treepanel",cls:"x-tree-panel x-grouptabbar",width:150,rootVisible:!1,store:t.store,hideHeaders:!0,animate:!1,processEvent:Ext.emptyFn,border:!1,plugins:[{ptype:"grouptabrenderer"}],viewConfig:{overItemCls:"",getRowClass:t.getRowClass},columns:[{xtype:"treecolumn",sortable:!1,dataIndex:"text",flex:1,renderer:function(e,t,n,r,i,s,o){var u="";if(n.parentNode&&n.parentNode.parentNode===null){u+=" x-grouptab-first";n.previousSibling&&(u+=" x-grouptab-prev");if(!n.get("expanded")||n.firstChild==null)u+=" x-grouptab-last"}else n.nextSibling===null?u+=" x-grouptab-last":u+=" x-grouptab-center";n.data.activeTab&&(u+=" x-active-tab");t.tdCls="x-grouptab"+u;return e}}]},{xtype:"container",flex:1,layout:"card",activeItem:t.mainItem,baseCls:Ext.baseCSSPrefix+"grouptabcontainer",items:t.cards}];t.addEvents("beforetabchange","tabchange","beforegroupchange","groupchange");t.callParent(arguments);t.setActiveTab(t.activeTab);t.setActiveGroup(t.activeGroup);t.mon(t.down("treepanel").getSelectionModel(),"select",t.onNodeSelect,t)},getRowClass:function(e,t,n,r){var i="";e.data.activeGroup&&(i+=" x-active-group");return i},onNodeSelect:function(e,t){var n=this,r=n.store.getRootNode(),i;t.parentNode&&t.parentNode.parentNode===null?i=t:i=t.parentNode;if(n.setActiveGroup(i.get("id"))===!1||n.setActiveTab(t.get("id"))===!1)return!1;while(r){r.set("activeTab",!1);r.set("activeGroup",!1);r=r.firstChild||r.nextSibling||r.parentNode.nextSibling}i.set("activeGroup",!0);i.eachChild(function(e){e.set("activeGroup",!0)});t.set("activeTab",!0);e.view.refresh()},setActiveTab:function(e){var t=this,n=e,r;Ext.isString(e)&&(n=Ext.getCmp(n));if(n===t.activeTab)return!1;r=t.activeTab;if(t.fireEvent("beforetabchange",t,n,r)!==!1){t.activeTab=n;t.rendered&&t.down("container[baseCls="+Ext.baseCSSPrefix+"grouptabcontainer"+"]").getLayout().setActiveItem(n);t.fireEvent("tabchange",t,n,r)}return!0},setActiveGroup:function(e){var t=this,n=e,r;Ext.isString(e)&&(n=Ext.getCmp(n));if(n===t.activeGroup)return!0;r=t.activeGroup;if(t.fireEvent("beforegroupchange",t,n,r)===!1)return!1;t.activeGroup=n;t.fireEvent("groupchange",t,n,r);return!0},createTreeStore:function(){var e=this,t=e.prepareItems(e.items),n={text:".",children:[]},r=e.cards=[];e.activeGroup=e.activeGroup||0;Ext.each(t,function(t,i){var s=t.items.items,o=s[t.mainItem]||s[0],u={children:[]};u.id=o.id;u.text=o.title;u.iconCls=o.iconCls;u.expanded=!0;u.activeGroup=e.activeGroup===i;u.activeTab=u.activeGroup?!0:!1;u.activeTab&&(e.activeTab=u.id);if(u.activeGroup){e.mainItem=t.mainItem||0;e.activeGroup=u.id}Ext.each(s,function(e){if(e.id!==u.id){var t={id:e.id,leaf:!0,text:e.title,iconCls:e.iconCls,activeGroup:u.activeGroup,activeTab:!1};u.children.push(t)}delete e.title;delete e.iconCls;r.push(e)});n.children.push(u)});return Ext.create("Ext.data.TreeStore",{fields:["id","text","activeGroup","activeTab"],root:{expanded:!0},proxy:{type:"memory",data:n}})},getActiveTab:function(){return this.activeTab},getActiveGroup:function(){return this.activeGroup}});