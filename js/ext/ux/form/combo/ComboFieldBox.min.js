/**
 *   ComboFieldBox
 */Ext.define("Ext.ux.ComboFieldBox",{extend:"Ext.form.field.ComboBox",alias:"widget.combofieldbox",requires:["Ext.ux.ComboView"],multiSelect:!0,maxHeight:150,descField:null,createNewOnEnter:!1,forceSelection:!0,selectOnTab:!1,trigger1Cls:Ext.baseCSSPrefix+"form-clear-trigger",trigger2Cls:Ext.baseCSSPrefix+"form-combo-trigger",listIconCls:"x-boundlist-icon",fieldSubTpl:['<div class="{hiddenDataCls}" role="presentation"></div>','<div id="{id}"','<tpl if="readOnly"> readonly="readonly"</tpl>','<tpl if="disabled"> disabled="disabled"</tpl>','<tpl if="tabIdx"> tabIndex="{tabIdx}"</tpl>','<tpl if="name"> name="{name}"</tpl>','<tpl if="fieldStyle"> style="{fieldStyle}"</tpl>','<tpl if="placeholder"> placeholder="{placeholder}"</tpl>','<tpl if="size"> size="{size}"</tpl>','class="{fieldCls} {typeCls} x-boxselect" autocomplete="off" />',"</div>",{compiled:!0,disableFormats:!0}],getSubTplData:function(){var e=this,t=e.getFieldStyle(),n=e.callParent(arguments);n.fieldStyle=(t||"")+";overflow:auto;height:"+(e.height?e.height+"px;":"auto;")+(e.maxHeight?"max-height:"+e.maxHeight+"px;":"");delete e.height;return n},alignPicker:function(){var e=this,t=e.getPicker(),n=e.triggerWidth;e.callParent(arguments);e.isExpanded&&e.matchFieldWidth&&t.setWidth(e.bodyEl.getWidth()-(e.trigger2Cls?2*n:n))},initComponent:function(){var e=this;if(!e.trigger1Cls){e.onTrigger1Click=null;e.trigger2Cls=null}e.getValueStore();e.listConfig=Ext.apply(e.listConfig||{},{selModel:{mode:"SIMPLE",enableKeyNav:!1}});(e.iconClsField||e.descField)&&Ext.apply(e.listConfig,{getInnerTpl:function(t){return'<div data-qtip="{'+e.descField+'}" class="'+(e.iconClsField&&e.listIconCls?e.listIconCls:"")+" {"+e.iconClsField+'}">{'+e.displayField+"}</div>"}});e.callParent(arguments)},onTrigger1Click:function(){var e=this;e.setValue("");e.collapse()},setValueStore:function(e){this.valueStore=e},getValueStore:function(){var e=this;return e.valueStore||(e.valueStore=e.createValueStore())},createValueStore:function(){return this.valueStore=new Ext.data.Store({model:this.store.model})},setStoreValues:function(){var e=this,t=e.getValueStore();e.setValue(t.data.extractValues(e.valueField||t.valueField,"data"));e.syncSelection()},getValueModels:function(){return this.valueModels||[]},afterSetValue:function(e){var t=this;t.valueStore.removeAll();t.valueStore.add(t.getValueModels());t.isExpanded&&t.alignPicker();t.syncSelection();t.updateLayout()},setValue:function(e,t){var n=this,r=n.getPicker(),i=r.preserveScrollOnRefresh;if(n.tempValue){e=Ext.Array.unique(e.concat(n.tempValue));var s=n.store.data.extractValues(n.valueField,"data");if(n.typeAhead&&n.store.getCount()==1){e.push(n.store.getAt(0).get(n.valueField));n._needCollapse=!0}n.store.data.addAll(Ext.Array.filter(n.valueStore.data.items,function(e){return s.indexOf(e.data[n.valueField])<0}));r.preserveScrollOnRefresh=!0;r.refresh();r.preserveScrollOnRefresh=i}n.callParent([e,!1]);n.afterSetValue(t)},getRawValue:function(){return Ext.value(this.rawValue,"")},doRawQuery:function(){var e=this,t;if(e.view&&e.typeAhead&&(t=e.view.inputEl.getValue())){e.tempValue=e.value;this.doQuery(t,!1,!0);delete e.tempValue;if(e._needCollapse){e.collapse();delete e._needCollapse}else{e.onExpand();e._preventClear=!0;e.view.inputEl.focus();e.view.inputEl.dom.value=t;delete e._preventClear}}},onBlur:function(){var e=this;e.view.inputEl.dom.value="";e.view.emptyEl&&e.view.emptyEl.show()},onFocus:function(){var e=this,t=e.view;e.callParent(arguments);if(e._preventClear!=1){e.store.clearFilter();e.picker.refresh()}if(t.emptyEl){t.emptyEl.setVisibilityMode(Ext.dom.AbstractElement.DISPLAY);t.emptyEl.hide()}e.view.focus()},buildKeyNav:function(){var e=this,t=e.selectOnTab,n=e.getPicker();return new Ext.view.BoundListKeyNav(n.el,{boundList:n,forceKeyDown:!0,tab:function(n){if(t||e.typeAhead){this.selectHighlighted(n);e.triggerBlur()}else e.onTriggerClick();return!0},esc:function(t){e.onTriggerClick()}})},onExpand:function(){var e=this,t=e.listKeyNav,n=e.selectOnTab,r=e.getPicker();t||(t=e.listKeyNav=e.buildKeyNav());n&&(e.ignoreMonitorTab=!0);Ext.defer(t.enable,1,t);r.focus();r.highlightItem(r.getNode(0))},onCollapse:function(){var e=this;e.callParent(arguments);e.view.focus()},createRecord:function(e){var t=this,n={};n[t.valueField]=e;n[t.displayField]=e;return n},afterComponentLayout:function(){var e=this;e.callParent(arguments);if(!e.view){var t=e.selectBoxOnTab,n=function(t){var n=this,r=n.boundList,i=r.all,s=r.highlightedItem,o=s?r.indexOf(s):-1,u=o<i.getCount()-1?o+t:0;n.highlightAt(u);e.view.focus()},r=function(t){console.info("del");if(e.readOnly||e.disabled||!e.editable)return;var n=this,r=n.boundList,i=r.highlightedItem,s;if(i){s=r.indexOf(i);e.getValueStore().remove(r.getRecord(i));e.setStoreValues();n.highlightAt(s);e.view.focus()}return!0};e.view=new Ext.ux.ComboView(Ext.apply({store:e.valueStore,emptyText:e.emptyText||"",field:e,renderTo:e.inputEl},e.viewCfg));var i=e.boxKeyNav=new Ext.view.BoundListKeyNav(e.view.el,{boundList:e.view,forceKeyDown:!0,down:function(t){if(e.isExpanded&&e.view.inputEl.getValue())return e.picker.focus();e.onTriggerClick()},right:function(e){n.call(this,1)},left:function(e){n.call(this,-1)},enter:function(t){if(e.readOnly||e.disabled||!e.editable)return;if(e.multiSelect&&e.createNewOnEnter==1&&t.getKey()==t.ENTER&&(rawValue=t.target.value)&&!Ext.isEmpty(rawValue)){rec=e.store.findExact(e.valueField,rawValue);rec<0&&(rec=e.store.add(e.createRecord(rawValue)));e.getValueStore().add(rec);e.setStoreValues()}e.view.focus()},tab:function(t){e.isExpanded&&t.target.value&&e.picker.focus();return!0},del:r,space:r});Ext.defer(i.enable,1,i)}},onDestroy:function(){var e=this;e.view&&Ext.destroy(e.view,e.boxKeyNav);e.callParent(arguments)}});