/**
 * @class Ext.ux.grid.plugin DragSelector
 * @extends Ext.util.Observable
 * 
 * @author Harald Hanek (c) 2011-2012
 * 
 * The Initial Developer of the Original Code is: Claudio Walser aka Foggy cwa[at]uwd.ch
 * @copyright 2007-2008, UWD GmbH, all rights reserved. License details:
 * http://www.gnu.org/licenses/lgpl.html
 */Ext.define("Ext.ux.grid.plugin.DragSelector",{extend:"Ext.util.Observable",requires:["Ext.dd.DragTracker","Ext.util.Region"],alias:"plugin.ux.dragselector",dragging:!1,scrollTopStart:0,scrollTop:0,targetDragSelector:".dragselect",dragSafe:!1,scrollSpeed:10,constructor:function(e){var t=this;t.addEvents("dragselectorstart","dragselectorend");t.callParent([e])},init:function(e){var t=this;t.grid=e;t.view=t.grid.getView();t.selModel=t.view.getSelectionModel();t.mon(t.view,"render",t.onRender,t);t.mon(t.view,"bodyscroll",t.syncScroll,t)},onRender:function(){var e=this;e.tracker=new Ext.dd.DragTracker({view:e.view,dragSelector:e,el:e.view.el,onBeforeStart:Ext.Function.bind(e.onBeforeStart,e),onStart:Ext.Function.bind(e.onStart,e),onDrag:Ext.Function.bind(e.onDrag,e),onEnd:Ext.Function.bind(e.onEnd,e)});e.dragRegion=new Ext.util.Region;e.scroller=e.view.getEl()},syncScroll:function(e){var t=this.scroller.getScroll().top;this.scrollTop=t-this.scrollTopStart;this.fillRegions();this.dragging&&this.onDrag(e,!0)},fillAllRegions:function(){var e=this,t=e.objectsSelected=[];e.mainRegion=e.scroller.getRegion();e.bodyRegion=e.scroller.getRegion();e.view.all.each(function(n){t.push(e.selModel.isSelected(t.length))},e);e.syncScroll()},fillRegions:function(){var e=this.rs=[];this.view.all.each(function(t){e.push(t.getRegion())})},cancelClick:function(e){var t=this,n=e.getTarget();t.ctrlState=e.ctrlKey;t.shiftState=e.shiftKey;!t.ctrlState&&!t.shiftState&&n.className==="x-grid-view"&&t.selModel.clearSelections();return!0},onBeforeStart:function(e){if(e.button===2)return!1;this.grid.editingPlugin&&this.grid.editingPlugin.editing;if(e.getPageX()>this.view.el.getX()+this.view.el.dom.clientWidth-20)return!1;this.cancelClick(e);return!this.dragSafe||e.target==this.view.el.dom||Ext.DomQuery.is(e.target,this.targetDragSelector)},onStart:function(e){var t=this;t.scrollTopStart=t.scroller.getScroll().top;t.fillAllRegions();t.getProxy().show();t.dragging=!0;t.fireEvent("dragselectorstart",t)},getProxy:function(){this.proxy||(this.proxy=this.view.getEl().createChild({tag:"div",cls:"x-view-selector"}));return this.proxy},onDrag:function(e,t){var n=this,r=n.view.getSelectionModel(),i=n.getProxy(),s=n.bodyRegion,o=n.tracker.startXY,u=n.dragRegion,a=n.tracker.getXY(),f=Math.abs(o[0]-a[0]),l=Math.min(o[0],a[0]),c=Math.min(o[1],a[1])-n.scrollTop,h=Math.abs(c-a[1]);a[0]<o[0]&&!t&&(a[0]+=2);if(n.scrollTop>=0){if(o[1]-n.scrollTop>a[1]){c=a[1];h=Math.abs(o[1]-a[1])-n.scrollTop}s.top-=n.scrollTop}else{if(o[1]-n.scrollTop>a[1]){c=a[1];h=Math.abs(o[1]-n.scrollTop-a[1])}s.bottom-=n.scrollTop}Ext.apply(u,{top:c,left:l,right:l+f,bottom:c+h});u.constrainTo(s);i.setRegion(u);var p=n.scroller;for(var d=0;d<n.rs.length;d++){var v=n.rs[d],m=u.intersect(v),g=r.isSelected(d),y=n.objectsSelected[d];n.ctrlState?y?m&&g?r.deselect(d):!m&&!g&&r.select(d,!0):m&&!g?r.select(d,!0):!m&&g&&r.deselect(d):m&&!g?r.select(d,!0):!m&&g&&r.deselect(d)}a[1]+10>=n.mainRegion.bottom&&(Ext.isIE?setTimeout(function(){p.scrollTo("top",p.getScroll().top+40)},100):n.setScrollTop(p.getScroll().top+n.scrollSpeed));a[1]-10<=n.mainRegion.top&&(Ext.isIE?setTimeout(function(){p.scrollTo("top",p.getScroll().top-40)},100):n.setScrollTop(p.getScroll().top-n.scrollSpeed))},setScrollTop:function(e){var t=this.scroller,n=t&&t.dom;if(n)return n.scrollTop=Ext.Number.constrain(e,0,n.scrollHeight-n.clientHeight)},onEnd:function(e){var t=this;t.dragging=!1;t.getProxy().hide();e.preventDefault();t.fireEvent("dragselectorend",t)}});