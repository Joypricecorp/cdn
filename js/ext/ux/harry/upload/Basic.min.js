/**
 * @class Ext.ux.upload.Basic
 * @extends Ext.util.Observable
 * 
 * @author Harald Hanek (c) 2011-2012
 * @license http://harrydeluxe.mit-license.org
 */Ext.define("Ext.ux.upload.Basic",{extend:"Ext.util.Observable",autoStart:!0,autoRemoveUploaded:!0,statusQueuedText:"Ready to upload",statusUploadingText:"Uploading ({0}%)",statusFailedText:"Error",statusDoneText:"Complete",statusInvalidSizeText:"File too large",statusInvalidExtensionText:"Invalid file type",configs:{uploader:{runtimes:"",url:"",browse_button:null,container:null,max_file_size:"128mb",resize:"",flash_swf_url:"",silverlight_xap_url:"",filters:[],chunk_size:null,unique_names:!0,multipart:!0,multipart_params:{},multi_selection:!0,drop_element:null,required_features:null}},constructor:function(e,t){var n=this;n.owner=e;n.success=[];n.failed=[];Ext.apply(n,t.listeners);n.uploaderConfig=Ext.apply(n,t.uploader,n.configs.uploader);n.addEvents("beforestart","uploadready","uploadstarted","uploadcomplete","uploaderror","filesadded","beforeupload","fileuploaded","updateprogress","uploadprogress","storeempty");Ext.define("Ext.ux.upload.Model",{extend:"Ext.data.Model",fields:["id","loaded","name","size","percent","status","msg"]});n.store=Ext.create("Ext.data.JsonStore",{model:"Ext.ux.upload.Model",listeners:{load:n.onStoreLoad,remove:n.onStoreRemove,update:n.onStoreUpdate,scope:n}});n.actions={textStatus:Ext.create("Ext.Action",{text:"<i>uploader not initialized</i>"}),add:Ext.create("Ext.Action",{text:t.addButtonText||"Add files",iconCls:t.addButtonCls,disabled:!1}),start:Ext.create("Ext.Action",{text:t.uploadButtonText||"Start",disabled:!0,iconCls:t.uploadButtonCls,handler:n.start,scope:n}),cancel:Ext.create("Ext.Action",{text:t.cancelButtonText||"Cancel",disabled:!0,iconCls:t.cancelButtonCls,handler:n.cancel,scope:n}),removeUploaded:Ext.create("Ext.Action",{text:t.deleteUploadedText||"Remove uploaded",disabled:!0,handler:n.removeUploaded,scope:n}),removeAll:Ext.create("Ext.Action",{text:t.deleteAllText||"Remove all",disabled:!0,handler:n.removeAll,scope:n})};n.callParent()},initialize:function(){var e=this;if(!e.initialized){e.initialized=!0;e.initializeUploader()}},destroy:function(){this.clearListeners()},setUploadPath:function(e){this.uploadpath=e},removeAll:function(){this.store.data.each(function(e){this.removeFile(e.get("id"))},this)},removeUploaded:function(){this.store.each(function(e){e&&e.get("status")==5&&this.removeFile(e.get("id"))},this)},removeFile:function(e){var t=this,n=t.uploader.getFile(e);n?t.uploader.removeFile(n):t.store.remove(t.store.getById(e))},cancel:function(){var e=this;e.uploader.stop();e.actions.start.setDisabled(e.store.data.length==0)},start:function(){var e=this;e.fireEvent("beforestart",e);e.multipart_params&&(e.uploader.settings.multipart_params=e.multipart_params);e.uploader.start()},initializeUploader:function(){var me=this;if(!me.uploaderConfig.runtimes){var runtimes=["html5"];me.uploaderConfig.flash_swf_url&&runtimes.push("flash");me.uploaderConfig.silverlight_xap_url&&runtimes.push("silverlight");runtimes.push("html4");me.uploaderConfig.runtimes=runtimes.join(",")}me.uploader=Ext.create("plupload.Uploader",me.uploaderConfig);Ext.each(["Init","ChunkUploaded","FilesAdded","FilesRemoved","FileUploaded","PostInit","QueueChanged","Refresh","StateChanged","BeforeUpload","UploadFile","UploadProgress","Error"],function(v){me.uploader.bind(v,eval("me._"+v),me)},me);me.uploader.init()},updateProgress:function(){var e=this,t=e.uploader.total,n=Ext.util.Format.fileSize(t.bytesPerSec),r=e.store.data.length,i=e.failed.length,s=e.success.length,o=i+s,u=r-s-i,a=t.percent;e.fireEvent("updateprogress",e,r,a,o,s,i,u,n)},updateStore:function(e){var t=this,n=t.store.getById(e.id);e.msg||(e.msg="");if(n){n.data=e;n.commit()}else t.store.loadData([e],!0)},onStoreLoad:function(e,t,n){this.updateProgress()},onStoreRemove:function(e,t,n){var r=this;if(!e.data.length){r.actions.start.setDisabled(!0);r.actions.removeUploaded.setDisabled(!0);r.actions.removeAll.setDisabled(!0);r.uploader.total.reset();r.fireEvent("storeempty",r)}var i=t.get("id");Ext.each(r.success,function(e){e&&e.id==i&&Ext.Array.remove(r.success,e)},r);Ext.each(r.failed,function(e){e&&e.id==i&&Ext.Array.remove(r.failed,e)},r);r.updateProgress()},onStoreUpdate:function(e,t,n){t.data=this.fileMsg(t.data);this.updateProgress()},fileMsg:function(e){var t=this;if(e.status&&e.server_error!=1)switch(e.status){case 1:e.msg=t.statusQueuedText;break;case 2:e.msg=Ext.String.format(t.statusUploadingText,e.percent);break;case 4:e.msg=e.msg||t.statusFailedText;break;case 5:e.msg=t.statusDoneText}return e},_Init:function(e,t){this.runtime=t.runtime;this.owner.enable(!0);this.fireEvent("uploadready",this)},_BeforeUpload:function(e,t){this.fireEvent("beforeupload",this,e,t)},_ChunkUploaded:function(){},_FilesAdded:function(e,t){var n=this;if(n.uploaderConfig.multi_selection!=1){if(n.store.data.length==1)return!1;t=[t[0]];e.files=[t[0]]}n.actions.removeUploaded.setDisabled(!1);n.actions.removeAll.setDisabled(!1);n.actions.start.setDisabled(e.state==2);Ext.each(t,function(e){n.updateStore(e)},n);n.fireEvent("filesadded",n,t)!==!1&&n.autoStart&&e.state!=2&&Ext.defer(function(){n.start()},300)},_FilesRemoved:function(e,t){Ext.each(t,function(e){this.store.remove(this.store.getById(e.id))},this)},_FileUploaded:function(e,t,n){var r=this,i=Ext.JSON.decode(n.response);if(i.success==1){t.server_error=0;r.success.push(t);r.fireEvent("fileuploaded",r,t,i)}else{i.message&&(t.msg='<span style="color: red">'+i.message+"</span>");t.server_error=1;r.failed.push(t);r.fireEvent("uploaderror",r,Ext.apply(n,{file:t}))}this.updateStore(t)},_PostInit:function(e){},_QueueChanged:function(e){},_Refresh:function(e){Ext.each(e.files,function(e){this.updateStore(e)},this)},_StateChanged:function(e){if(e.state==2){this.fireEvent("uploadstarted",this);this.actions.cancel.setDisabled(!1);this.actions.start.setDisabled(!0)}else{this.fireEvent("uploadcomplete",this,this.success,this.failed);this.autoRemoveUploaded&&this.removeUploaded();this.actions.cancel.setDisabled(!0);this.actions.start.setDisabled(this.store.data.length==0)}},_UploadFile:function(e,t){},_UploadProgress:function(e,t){var n=this,r=t.name,i=t.size,s=t.percent;n.fireEvent("uploadprogress",n,t,r,i,s);t.server_error&&(t.status=4);n.updateStore(t)},_Error:function(e,t){if(t.file){t.file.status=4;t.code==-600?t.file.msg=Ext.String.format('<span style="color: red">{0}</span>',this.statusInvalidSizeText):t.code==-700?t.file.msg=Ext.String.format('<span style="color: red">{0}</span>',this.statusInvalidExtensionText):t.file.msg=Ext.String.format('<span style="color: red">{2} ({0}: {1})</span>',t.code,t.details,t.message);this.failed.push(t.file);this.updateStore(t.file)}this.fireEvent("uploaderror",this,t)}});