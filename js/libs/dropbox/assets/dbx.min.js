/**
 * -----------------------------------
 * Jpx Dropbox - core script
 * v1.0
 *
 * Copyright 2013, nukboon@gmail.com
 * -----------------------------------
 * 
 * @package Jpx_Dropbox
 * @version 1.0
 * @author nukboon@gmail.com
 * @copyright (c) 2013 nukboon@gmail.com
 * 
 **/!function(e){var t,n,r=function(){},i=window.console,s=e("body").css("overflow"),o="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==",u=function(e){return t+e},a=function(e){return e},f={url:n,url_start:n,autoload:!0,dialog:{width:840,height:550,autoOpen:!0,modal:!0,draggable:!0,resizable:!0,title:"Choose Image"},uploader:{file_size:"5mb",file_exts:"jpeg,jpg,gif,png"},events:{choose:r,open:r,close:r}},l=function(n){t=n.url;var r=this;this.options={dialog:f.dialog,uploader:f.uploader,events:f.events};e.extend(this.options.dialog,n.dialog||{});e.extend(this.options.uploader,n.uploader||{});e.extend(this.options.events,n.events||{});this.loading(!0);this.loaded=!1;this.start_url=t+(n.url_start||"/");this.options.autoload===!0&&this.options.dialog.autoOpen!==!1&&this.load(r.start_url);e.extend(this.options.dialog,{open:function(t){r.loaded===!1&&r.load(r.start_url);r.options.events.open&&r.options.events.open.call(r,this,t);e("body").css("overflow","hidden")},close:function(t){r.options.events.close&&r.options.events.close.call(r,this,t);e("body").css("overflow",s)},resize:function(e,t){r.calculate_screen_size(t.size)}});this.scope=e('<div class="jpx-dropbox"></div>').appendTo("body").dialog(this.options.dialog);this.scope.append('<div class="jpx-loading"><div class="jpx-spinner"></div></div>').closest(".ui-dialog").addClass("jpx jpx-dialog")};l.prototype={constructor:l,open:function(){this.scope.dialog("open")},close:function(){this.scope.dialog("close")},load:function(e){this.reload(e)},reload:function(n){var r=this;this.loading(!0);n=n||t;e.get(n,function(t){var n=e(".jpx-loading",r.scope);r.scope.html(t);r.scope.append(n);r.init(r.scope);r.loading(!1);r.loaded=!0;if(r.scope.hasClass("jpx-view-thumb")){e(".jpx-btn-group button",r.scope).removeClass("active");e(".jpx-btn-thumb",r.scope).addClass("active")}})},loading:function(t){var n=e(".jpx-loading");n.css("background-color",e(".jpx-list",this.scope).length?"rgba(255,255,255, .5)":"#fff");t===!0?n.css("display","block"):n.fadeOut(400)},disable:function(t,n){typeof t=="string"&&(t=e(t));return t.attr("disabled",n)},update_toolbar:function(t){this.disable(".jpx-btn-rename",t);this.disable(".jpx-btn-delete",t);var n=e(".jpx-item-selected",this.scope);this.disable(".jpx-btn-choose",!0);this.disable(".jpx-btn-getlink",!0);this.disable(".jpx-btn-preview",!0);if(n.length){var r=n.data("type")==="folder",i=n.data("img")==="yes";this.disable(".jpx-btn-choose",!i);this.disable(".jpx-btn-getlink",r||!i);this.disable(".jpx-btn-preview",!i)}},open_camera:function(t,n){function m(e){var t=new Image;t.src=e.toDataURL("image/png");return t}function g(){s.msg("Access to camera was denied!",3)}function y(t){u=t;f.show();l.hide();c.hide();d.onerror=function(){i.log("video error");d&&stop()};t.onended=g;if(window.webkitURL)d.src=window.webkitURL.createObjectURL(t);else if(d.mozSrcObject!==undefined){d.mozSrcObject=t;d.play()}else if(navigator.mozGetUserMedia){d.src=t;d.play()}else window.URL?d.src=window.URL.createObjectURL(t):d.src=t;e(p).show();e(v).hide();e(s).hide();e(h).show()}function b(){typeof window=="undefined"||typeof navigator=="undefined"?s.msg("This page needs a web browser to open.",1):navigator.getUserMedia?navigator.getUserMedia(o,y,g):navigator.oGetUserMedia?navigator.oGetUserMedia(o,y,g):navigator.mozGetUserMedia?navigator.mozGetUserMedia(o,y,g):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(o,y,g):navigator.msGetUserMedia?navigator.msGetUserMedia({video:!0,audio:!1},y,g):s.msg("getUserMedia() not available from your web browser!",2)}function w(){if(u){u.stop?u.stop():u.msStop&&u.msStop();u.onended=null;u=null}if(d){d.onerror=null;d.pause&&d.pause();d.mozSrcObject&&(d.mozSrcObject=null);d.src=""}}function E(){f.hide();l.show();c.show();e(p).hide();e(v).fadeIn();e(s).hide();e(h).show();v.width=d.videoWidth;v.height=d.videoHeight;v.getContext("2d").drawImage(d,0,0,640,480)}var r=e(".jpx-snaper",this.scope),s="",o={video:!0},u=null;if(!r.length){r=e('<div class="jpx-snaper"><div class="jpx-message"><h3></h3><div class="jpx-message-body"></div></div><div class="jpx-video"><video width="640" height="480" autoplay="autoplay"></video></div><canvas class="jpx-canvas" width="640" height="480" style="display:none"></canvas><div class="jpx-snaper-buttons"><button class="jpx-btn jpx-btn-ok jpx-btn-snap"><span>'+a("Snap Photo")+"</span></button>"+'<button class="jpx-btn jpx-btn-ok jpx-btn-select"><span>'+a("Use this photo")+"</span></button>"+'<button class="jpx-btn jpx-btn-snap-clear"><span>'+a("Clear Photo")+"</span></button>"+"</div>"+"</div>").appendTo(this.scope);r.dialog({title:a("Take Photo"),width:640,modal:!1,close:function(){i.log("close");w()},open:function(){b()}}).closest(".ui-dialog").addClass("jpx jpx-dialog-snaper")}var f=e(".jpx-btn-snap",r),l=e(".jpx-btn-snap-clear",r).hide(),c=e(".jpx-btn-select",r).hide(),h=e(".jpx-snaper-buttons",r).hide().get(0),s=e(".jpx-message",r).get(0),p=e(".jpx-video",r).get(0),d=e("video",p).get(0),v=e(".jpx-canvas",r).get(0);s.msg=function(t,n){var r=e("h3",this),i=e("div",this);if(n==0){r.text(a(t));i.html(a("To take photo you must allow your camera before."))}else if(n==3){r.text(a(t));i.html("https://support.google.com/chrome/answer/2693767?p=ib_access_cam_mic&rd=1")}else{r.text(a(t));i.html("")}};s.msg("Allow your camera.",0);f.on("click",function(){E()});l.on("click",function(){i.log("clear click");e(p).show();e(v).hide();e(s).hide();e(h).show();f.show();l.hide();c.hide()});c.on("click",function(){i.log("select click");var e=new mOxie.Image;e.onload=function(){this.name=this.uid+".png";n.plupload("getUploader").addFile(new plupload.File(this));r.dialog("close")};e.load(m(v).src)})},create_preview_panel:function(t,n,r){var i=e(".jpx-prv");i.length&&i.remove();i=e('<div class="jpx jpx-prv jpx-prv-loading jpx-animated jpx-bounce-in"><div class="jpx-prv-header"><button type="buton" class="jpx-btn"><span>✕</span></button><img/><div class="jpx-prv-meta"><span class="jpx-prv-label"/><span class="jpx-prv-state"><span class="jpx-spinner"/>'+(r?r:"Loading Preview ...")+"</span>"+'<span class="jpx-prv-dt">'+'<b>size:</b><span class="jpx-size"></span>'+'<b>kind:</b><span class="jpx-kind"></span>'+'<br><b>modified:</b><span class="jpx-modified"></span>'+"</span>"+"</div>"+"</div>"+'<div class="jpx-prv-viewer"/>'+"</div>").appendTo("body");var s=e("img",i),o=e(".jpx-prv-label",i),u=e(".jpx-prv-meta",i),n=n||e(".jpx-item-selected",this.scope),a=e("img",n).data("original");a||(a=e(".jpx-item-selected",this.scope).data("original"));var f=a.split("/").pop();o.text(f);s.css("background-image","url('"+a+"')");i.show();setTimeout(function(){i.removeClass("jpx-bounce-in")},350);e("button",i).on("click",function(){i.addClass("jpx-bounce-out");setTimeout(function(){i.remove()},300)});var l=this;this.get_link(n,function(r){if(!r){alert("Can't show preview in this time.");return}e(".jpx-size",i).text(e(".jpx-size",n).text());e(".jpx-kind",i).text(e(".jpx-kind",n).text());e(".jpx-modified",i).text(e(".jpx-modified",n).text());t.call(l,i,r,n)})},get_link:function(t,n){var r=this;t.data("link")?n.call(r,t.data("link")):e.get(u("/link"+t.data("path")),function(e){t.data("link",e);n.call(r,e)})},display_preview:function(t,n){var r=new Image;r.src=n;r.onload=function(){var i=e(".jpx-prv-header",t),s=e(".jpx-prv-viewer",t).append(r).append('<span class="jpx-file-link"><b>link:</b><a href="'+n+'"  title="go to - '+n+'" target="_new">'+n+"</a>"+"</span>");t.removeClass("jpx-prv-loading").addClass("jpx-prv-full");var o={};o.width=e(window).innerWidth()-50;o.height=e(window).innerHeight()-50;var u=r.width<o.width?r.width:o.width,a=r.height<o.height?r.height:o.height,f=parseInt(s.css("padding-left"))+parseInt(s.css("padding-right")),l=parseInt(s.css("padding-top"))+parseInt(s.css("padding-bottom")),c=e(".jpx-file-link",s).outerHeight(),h=i.outerHeight(!0)+c,p=r.width,d=r.height;p>u&&(p=u);d>a&&(d=a);p>=o.width-f&&(p-=f);d>=o.height-l-h&&(d=d-l-h);var v=e(r);if(v.width()>p){v.width(p);v.height("auto")}if(v.height()>d){v.height(d);v.width("auto")}p=v.width()+f;d=v.height()+l+h;p<400&&(p=400);t.css({width:p,height:d,"margin-left":-(p/2)+"px","margin-top":-(d/2)+"px"}).addClass("jpx-bounce-in")}},calculate_screen_size:function(t){var n=this.scope,r="outerWidth";if(n.hasClass("jpx-view-thumb")){e(".jpx-name",n).css("width","auto");return}t=t||{width:n.outerWidth(),height:n.outerHeight()};var i=e("img",n),s=e(".jpx-name",n),o=e(".jpx-kind",n),u=e(".jpx-size",n),a=e(".jpx-modified",n),f=t.width-(i[r]()+o[r]()+u[r]()+a[r]()+30);s.width(f)},init:function(t){var n=this,r=e(".jpx-path",t),s=e(".jpx-lists",t),f=e(".jpx-folders",t),l=e(".jpx-files",t),c=e('<input type="text" required="required">'),h=e('<div class="jpx-uploader"></div>').appendTo(t);this.calculate_screen_size();e(".jpx-lazy",s).lazyload({container:s,threshold:500,spindelay:2e3}).update();e(".jpx-modified",s).humane_dates();s.on("jpx-viewchange",function(t,r){e(this).closest(".jpx-dropbox").toggleClass("jpx-view-thumb",r==="thumb");s.scrollTop(1);n.calculate_screen_size()}).on("jpx.itemselectechange",function(t,n,r){var i="jpx-item-selected",o=!0;if(r==="click"&&n.hasClass(i)&&!n.hasClass("jpx-item-active")){n.removeClass(i);o=!1}else{e("."+i,this).removeClass(i);n.addClass(i);if(r!=="click"||n.hasClass("jpx-item-active"))o=!1}s.trigger("jpx.selectchange",[n,o])}).on("jpx.selectchange",function(e,t,r){n.update_toolbar(!r)}).on("jpx.foldersaved",".jpx-label",function(t,n,r,i){var a=e(this);if(n&&n.error){alert(n.msg.error);r.attr("disabled",!1).show().focus().select().addClass("jpx-input-error");return}i.fadeOut(function(){i.remove()});if(!n)return;if(n.meta){var l='href="'+u(n.meta.path)+'"',c=e('<li class="jpx-item" data-type="folder" data-img="no"><img src="'+o+'" data-'+l+">"+'<span class="jpx-name">'+"<a "+l+' class="jpx-label">'+n.name+"</a>"+"</span>"+'<span class="jpx-kind">folder</span>'+'<span class="jpx-size">--</span>'+'<span class="jpx-modified" title="'+n.meta.modified+'">'+n.meta.modified+"</span>"+"</li>").hide().appendTo(f).hide().fadeIn();e(".jpx-modified",c).humane_dates();s.trigger("jpx.itemselectechange",[c,"click"])}}).on("jpx.rename",".jpx-label",function(){if(!confirm("To rename file/folder may take an existing link to lost. Do you want to continue?"))return;var t=e(this).closest(".jpx-item");c.trigger("append",[this,t.data("type")])}).on("click",".jpx-item",function(t){if(e(t.target).hasClass("jpx-lazy")&&e(this).hasClass("jpx-item-selected"))return!1;s.trigger("jpx.itemselectechange",[e(this),"click"])});f.on("dblclick",".jpx-item",function(){n.reload(u(e(this).data("path")))}).on("click","a.jpx-label",function(t){t.preventDefault();if(!e(t.target).hasClass("jpx-label"))return;n.reload(e(this).attr("href"))}).on("click","img",function(t){n.reload(e(this).data("href"))});l.on("jpx.uploaded",function(t,n){var r=e('<li class="jpx-item" data-type="file" data-path="'+n.meta.path+'" data-img="yes">'+'<img class="jpx-lazy" src="'+o+'" data-original="'+u("/tmb"+n.meta.path)+'">'+'<span class="jpx-name">'+'<span class="jpx-label">'+n.name+"</span>"+"</span>"+'<span class="jpx-kind">'+n.meta.mime_type+"</span>"+'<span class="jpx-size">'+n.meta.size+"</span>"+'<span class="jpx-modified" title="'+n.meta.modified+'">'+n.meta.modified+"</span>"+"</li>").hide();e(".jpx-modified",r).humane_dates();e(".jpx-lazy",r).css("background-image","url('"+u("/tmb"+n.meta.path)+"')");var i=e("img",r).bind("load",function(){s.fadeOut(2e3,function(){s.remove()})}),s=e('<div class="jpx-spinner"/>').appendTo(this).css({position:"absolute",width:i.outerWidth(!0),height:i.outerHeight(!0)});r.prependTo(this).fadeIn()}).on("click",".jpx-lazy",function(t){n.create_preview_panel(function(e,t){n.display_preview(e,t)},e(this).closest(".jpx-item"))});c.on("blur",function(){var t=e(this).clone(!0);e(this).closest(".jpx-label").text(e(this).data("origin_text")).closest(".jpx-name").removeClass("jpx-renaming");c=t;n.update_toolbar(!1)}).on("save",function(){var t=e(this),n=e(this).data(),i=e.trim(e(this).val()),s=e(this).closest(".jpx-label"),o=e(this).clone(!0);c=o.removeClass("jpx-input-error");if(i==n["origin_name"])e(this).trigger("saved",[null,s]);else if(i===""){alert("กรุณาระบุชื่อที่ต้องการเปลี่ยน");e(this).focus()}else{var a={origin:n.origin_text,name:n.origin_ext?i+"."+n.origin_ext:i,path:r.data("path")};s.text("Saving...");e.post(u("/rename"),a,function(e){o.trigger("saved",[e,s])})}}).on("keydown",function(t){(t.which==13||t.which==9)&&e(this).trigger("save");t.which==27&&e(this).trigger("blur")}).on("saved",function(t,r,i){var s=e(this).data(),o=s.origin_text;if(r&&r.error){alert(r.msg.error);i.text(s.origin_name);e(this).addClass("jpx-input-error").trigger("append",i,s.origin_type);return}r&&(o=r.name);i.text(o);i.closest(".jpx-name").removeClass("jpx-renaming");var a=i.closest(".jpx-item").data("path",r.meta.path).data("link",null);e("img",a).data("original",u("/tmb"+r.meta.path));n.update_toolbar(!1)}).on("append",function(t,r,i){var s=e(r).text(),o=s,u=null;if(i=="file"){u=s.split(".").pop();o=s.replace(/\.[^.]+$/,"")}e(r).text("");e(this).appendTo(r).data("origin_text",s).data("origin_name",o).data("origin_ext",u).data("origin_type",i).val(o).show();e(r).closest(".jpx-name").addClass("jpx-renaming");n.update_toolbar(!0)});e(".jpx-btn-choose",t).on("click",function(){if(!n.options.events.choose)return;var t=e(".jpx-item-selected",n.scope);if(!t.length){alert(a("Please select once of you want to choose."));return}if(t.data("link")){n.options.events.choose.call(n,t.data("link"),t,n.scope);return}var r=e(this).attr("disabled",!0);e("span",r).text(a("waiting..."));n.get_link(t,function(i){n.options.events.choose.call(n,i,t,n.scope);r.attr("disabled",!1);e("span",r).text(a("Choose"))})});e(".jpx-btn-preview",t).on("click",function(){var t=e(".jpx-item-selected",n.scope);if(!t.length){alert(a("Please select once of you want to preview."));return}n.create_preview_panel(function(e,t){n.display_preview(e,t)},t)});e(".jpx-btn-getlink",t).on("click",function(){var t=e(".jpx-item-selected",n.scope);if(!t.length){alert(a("Please select once of you want to get the link."));return}n.create_preview_panel(function(t,n,r){var i=e(".jpx-prv-viewer",t).append('<textarea readonly="readonly" />');t.removeClass("jpx-prv-loading").addClass("jpx-prv-full jpx-panel-getlink");e("textarea",i).val(n).on("focus",function(){e(this).select()}).on("mouseup",function(e){e.preventDefault()});e("button",t).on("click",function(){t.addClass("jpx-bounce-out");setTimeout(function(){t.remove()},300)})},t,"Geting image link...")});e(".jpx-btn-thumb, .jpx-btn-list",t).on("click",function(){var t=e(this).parent();e(".active",t).removeClass("active");e(this).addClass("active");s.trigger("jpx-viewchange",[e(this).hasClass("jpx-btn-thumb")?"thumb":"list"])});e(".jpx-btn-refresh",t).on("click",function(){n.reload(r.data("url"))});e(".jpx-btn-back",t).on("click",function(){n.reload(e(this).data("url"))});e(".jpx-btn-rename",t).on("click",function(t){var r=e(".jpx-item-selected",n.scope);if(!r.length){alert("Please select once of you want to rename.");return}e(".jpx-label",r).trigger("jpx.rename")});e(".jpx-btn-delete",t).on("click",function(t){var r=e(".jpx-item-selected",n.scope);if(!r.length){alert("Please select once of you want to delete.");return}if(!confirm("To delete file/folder may take your existing link to lost. Do you want to continue?"))return;var i=e(".jpx-label",r),s=i.text();i.text("Deleting...");e.post(u("/delete"),{path:r.data("path")},function(t){if(t.error){i.text(s);alert(t.msg.error);return}r.fadeOut(function(){e(this).remove();n.update_toolbar(!0)})})});e(".jpx-btn-add-file",t).click(function(){e(d()).dialog("open")});e(".jpx-btn-add-folder",t).click(function(){var t=e('<li class="jpx-item jpx-item-active" data-type="folder"><img src="'+o+'">'+'<span class="jpx-name"><span class="jpx-label">'+'<input type="text" required="required">'+'<span class="jpx-saving">Saving...<span>'+"</span></span>"+"</li>").appendTo(f),n=e(".jpx-saving",t).hide();s.trigger("jpx.itemselectechange",[t]);var i=e(".jpx-label",t),a=e("input",i).on("save",function(){var s=e.trim(e(this).val()),o=r.data("path");if(s===""){alert("Enter you folder name.");e(this).val("");return}n.show();e(this).hide();e.post(u("/folder/save"),{path:o,name:s},function(e){n.hide();i.trigger("jpx.foldersaved",[e,a,t])})}).on("keydown",function(t){(t.which==13||t.which==9)&&e(this).trigger("save");t.which==27&&e(this).trigger("jpx.blur")}).on("jpx.blur",function(){t.remove()}).on("blur",function(n){e.trim(e(this).val())===""&&t.remove()}).focus()});e(".jpx-path-name",t).on("click",function(){e(this).toggleClass("selected",!e(this).hasClass("selected"))}).on("click","li a",function(t){t.preventDefault();n.reload(e(this).attr("href"))});var p=!1,d=function(){if(p)return h;p=!0;h=e(".jpx-uploader",t).plupload({runtimes:"html5",url:u("/upload"),max_file_size:n.options.uploader.file_size||"5mb",unique_names:!1,multipart_params:{path:r.data("path")},resize:{quality:100},filters:[{title:"Files",extensions:n.options.uploader.file_exts||"jpeg,jpg,gif,png"}],rename:!1,sortable:!0,dragdrop:!0,views:{list:!0,thumbs:!0,active:"list"},init:{StateChanged:function(t){var n=e(".plupload_add,.plupload_start,.plupload_snap",h);n.css("display",t.state==plupload.STARTED?"none":"inline-block")},FileUploaded:function(t,n,r){var i=e.parseJSON(r.response);l.trigger("jpx.uploaded",[i])},Error:function(e,t){i.log(arguments)}}}).dialog({title:"Uploade files",autoOpen:!1,modal:!1,width:550,close:function(){h.plupload("getUploader").splice();e(".plupload_filelist_content",h).empty()},open:function(){var t=e(".plupload_snap",this);if(!t.length){t=e('<a class="plupload_button plupload_snap">'+a("Take Photo")+"</a>").insertBefore(".plupload_start",this).jpxbutton({icons:{primary:"ui-icon-camera"}}).on("click",function(){n.open_camera(this,h)});e(".plupload_filelist_footer .plupload_button",h).addClass("jpx-btn");e(".plupload_view_switch .plupload_button",h).addClass("jpx-btn-x");e('[for="plupload_view_list"]',h).addClass("ui-state-active")}}});h.closest(".ui-dialog").addClass("jpx jpx-dialog-uploader");return h}}};window.JpxDropbox=l}(jQuery);!function(e){function t(e){var t=[[60,"just now"],[90,"1 minute"],[3600,"minutes",60],[5400,"1 hour"],[86400,"hours",3600],[129600,"1 day"],[604800,"days",86400],[907200,"1 week"],[2628e3,"weeks",604800],[3942e3,"1 month"],[31536e3,"months",2628e3],[47304e3,"1 year"],[31536e5,"years",31536e3],[47304e5,"1 century"]],n=(""+e).replace(/-/g,"/").replace(/[TZ]/g," "),r=new Date,i=(r-new Date(n))/1e3,s=" ago",o=0,u;if(i<0){i=Math.abs(i);s=""}while(u=t[o++])if(i<u[0])return u.length==2?u[1]+(o>1?s:""):Math.round(i/u[2])+" "+u[1]+(o>1?s:"");return i>47304e5?Math.round(i/47304e5)+" centuries"+s:e}typeof jQuery!="undefined"&&(jQuery.fn.humane_dates=function(){return this.each(function(){var e=t(this.title);e&&jQuery(this).text()!=e&&jQuery(this).text(e)})})}(jQuery);