/**
 * jquery.ui.plupload.js
 *
 * Copyright 2013, Moxiecode Systems AB
 * Released under GPL License.
 *
 * License: http://www.plupload.com/license
 * Contributing: http://www.plupload.com/contributing
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.widget.js
 *	jquery.ui.jpxbutton.js
 *	jquery.ui.progressbar.js
 *	
 * Optionally:
 *	jquery.ui.sortable.js
 *//* global jQuery:true *//**
jQuery UI based implementation of the Plupload API - multi-runtime file uploading API.

To use the widget you must include _jQuery_ and _jQuery UI_ bundle (including `ui.core`, `ui.widget`, `ui.jpxbutton`, 
`ui.progressbar` and `ui.sortable`).

In general the widget is designed the way that you do not usually need to do anything to it after you instantiate it. 
But! You still can intervenue, to some extent, in case you need to. Although, due to the fact that widget is based on 
_jQuery UI_ widget factory, there are some specifics. See examples below for more details.

@example
	<!-- Instantiating: -->
	<div id="uploader">
		<p>Your browser doesn't have Flash, Silverlight or HTML5 support.</p>
	</div>

	<script>
		$('#uploader').plupload({
			url : '../upload.php',
			filters : [
				{title : "Image files", extensions : "jpg,gif,png"}
			],
			rename: true,
			sortable: true,
			flash_swf_url : '../../js/Moxie.swf',
			silverlight_xap_url : '../../js/Moxie.xap',
		});
	</script>

@example
	// Invoking methods:
	$('#uploader').plupload(options);

	// Display welcome message in the notification area
	$('#uploader').plupload('notify', 'info', "This might be obvious, but you need to click 'Add Files' to add some files.");

@example
	// Subscribing to the events...
	// ... on initialization:
	$('#uploader').plupload({ 
		...
		viewchanged: function(event, args) {
			// stuff ...
		}
	});
	// ... or after initialization
	$('#uploader').on("viewchanged", function(event, args) {
		// stuff ...
	});

@class UI.Plupload
@constructor
@param {Object} settings For detailed information about each option check documentation.
	@param {String} settings.url URL of the server-side upload handler.
	@param {Number|String} [settings.chunk_size=0] Chunk size in bytes to slice the file into. Shorcuts with b, kb, mb, gb, tb suffixes also supported. `e.g. 204800 or "204800b" or "200kb"`. By default - disabled.
	@param {String} [settings.file_data_name="file"] Name for the file field in Multipart formated message.
	@param {Array} [settings.filters=[]] Set of file type filters, each one defined by hash of title and extensions. `e.g. {title : "Image files", extensions : "jpg,jpeg,gif,png"}`. Dispatches `plupload.FILE_EXTENSION_ERROR`
	@param {String} [settings.flash_swf_url] URL of the Flash swf.
	@param {Object} [settings.headers] Custom headers to send with the upload. Hash of name/value pairs.
	@param {Number|String} [settings.max_file_size] Maximum file size that the user can pick, in bytes. Optionally supports b, kb, mb, gb, tb suffixes. `e.g. "10mb" or "1gb"`. By default - not set. Dispatches `plupload.FILE_SIZE_ERROR`.
	@param {Number} [settings.max_retries=0] How many times to retry the chunk or file, before triggering Error event.
	@param {Boolean} [settings.multipart=true] Whether to send file and additional parameters as Multipart formated message.
	@param {Object} [settings.multipart_params] Hash of key/value pairs to send with every file upload.
	@param {Boolean} [settings.multi_selection=true] Enable ability to select multiple files at once in file dialog.
	@param {Boolean} [settings.prevent_duplicates=false] Do not let duplicates into the queue. Dispatches `plupload.FILE_DUPLICATE_ERROR`.
	@param {String|Object} [settings.required_features] Either comma-separated list or hash of required features that chosen runtime should absolutely possess.
	@param {Object} [settings.resize] Enable resizng of images on client-side. Applies to `image/jpeg` and `image/png` only. `e.g. {width : 200, height : 200, quality : 90, crop: true}`
		@param {Number} [settings.resize.width] If image is bigger, it will be resized.
		@param {Number} [settings.resize.height] If image is bigger, it will be resized.
		@param {Number} [settings.resize.quality=90] Compression quality for jpegs (1-100).
		@param {Boolean} [settings.resize.crop=false] Whether to crop images to exact dimensions. By default they will be resized proportionally.
	@param {String} [settings.runtimes="html5,flash,silverlight,html4"] Comma separated list of runtimes, that Plupload will try in turn, moving to the next if previous fails.
	@param {String} [settings.silverlight_xap_url] URL of the Silverlight xap.
	@param {Boolean} [settings.unique_names=false] If true will generate unique filenames for uploaded files.

	@param {Boolean} [settings.autostart=false] Whether to auto start uploading right after file selection.
	@param {Boolean} [settings.dragdrop=true] Enable ability to add file to the queue by drag'n'dropping them from the desktop.
	@param {Boolean} [settings.rename=false] Enable ability to rename files in the queue.
	@param {Boolean} [settings.sortable=false] Enable ability to sort files in the queue, changing their uploading priority.
	@param {Object} [settings.buttons] Control the visibility of functional buttons. 
		@param {Boolean} [settings.buttons.browse=true] Display browse button.
		@param {Boolean} [settings.buttons.start=true] Display start button.
		@param {Boolean} [settings.buttons.stop=true] Display stop button. 
	@param {Object} [settings.views] Control various views of the file queue.
		@param {Boolean} [settings.views.list=true] Enable list view.
		@param {Boolean} [settings.views.thumbs=false] Enable thumbs view.
		@param {String} [settings.views.default='list'] Default view.
		@param {Boolean} [settings.views.remember=true] Whether to remember the current view (requires jQuery Cookie plugin).
	@param {Boolean} [settings.multiple_queues=true] Re-activate the widget after each upload procedure.
	@param {Number} [settings.max_file_count=0] Limit the number of files user is able to upload in one go, autosets _multiple_queues_ to _false_ (default is 0 - no limit).
*/(function(e,t){var n,r,i,s,o="ui-button ui-widget ui-state-default ui-corner-all",u="ui-state-hover ui-state-active ",a="ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only",f=function(){var t=e(this);setTimeout(function(){t.find(":ui-button").jpxbutton("refresh")},1)},l=function(t){var n=t.name,r=t.form,i=e([]);if(n){n=n.replace(/'/g,"\\'");r?i=e(r).find("[name='"+n+"']"):i=e("[name='"+n+"']",t.ownerDocument).filter(function(){return!this.form})}return i};e.widget("ui.jpxbutton",{version:"1.10.3",defaultElement:"<button>",options:{disabled:null,text:!0,label:null,icons:{primary:null,secondary:null}},_create:function(){this.element.closest("form").unbind("reset"+this.eventNamespace).bind("reset"+this.eventNamespace,f);typeof this.options.disabled!="boolean"?this.options.disabled=!!this.element.prop("disabled"):this.element.prop("disabled",this.options.disabled);this._determineButtonType();this.hasTitle=!!this.buttonElement.attr("title");var t=this,u=this.options,a=this.type==="checkbox"||this.type==="radio",c=a?"":"ui-state-active",h="ui-state-focus";u.label===null&&(u.label=this.type==="input"?this.buttonElement.val():this.buttonElement.html());this._hoverable(this.buttonElement);this.buttonElement.addClass(o).attr("role","button").bind("mouseenter"+this.eventNamespace,function(){if(u.disabled)return;this===n&&e(this).addClass("ui-state-active")}).bind("mouseleave"+this.eventNamespace,function(){if(u.disabled)return;e(this).removeClass(c)}).bind("click"+this.eventNamespace,function(e){if(u.disabled){e.preventDefault();e.stopImmediatePropagation()}});this.element.bind("focus"+this.eventNamespace,function(){t.buttonElement.addClass(h)}).bind("blur"+this.eventNamespace,function(){t.buttonElement.removeClass(h)});if(a){this.element.bind("change"+this.eventNamespace,function(){if(s)return;t.refresh()});this.buttonElement.bind("mousedown"+this.eventNamespace,function(e){if(u.disabled)return;s=!1;r=e.pageX;i=e.pageY}).bind("mouseup"+this.eventNamespace,function(e){if(u.disabled)return;if(r!==e.pageX||i!==e.pageY)s=!0})}if(this.type==="checkbox")this.buttonElement.bind("click"+this.eventNamespace,function(){if(u.disabled||s)return!1});else if(this.type==="radio")this.buttonElement.bind("click"+this.eventNamespace,function(){if(u.disabled||s)return!1;e(this).addClass("ui-state-active");t.buttonElement.attr("aria-pressed","true");var n=t.element[0];l(n).not(n).map(function(){return e(this).jpxbutton("widget")[0]}).removeClass("ui-state-active").attr("aria-pressed","false")});else{this.buttonElement.bind("mousedown"+this.eventNamespace,function(){if(u.disabled)return!1;e(this).addClass("ui-state-active");n=this;t.document.one("mouseup",function(){n=null})}).bind("mouseup"+this.eventNamespace,function(){if(u.disabled)return!1;e(this).removeClass("ui-state-active")}).bind("keydown"+this.eventNamespace,function(t){if(u.disabled)return!1;(t.keyCode===e.ui.keyCode.SPACE||t.keyCode===e.ui.keyCode.ENTER)&&e(this).addClass("ui-state-active")}).bind("keyup"+this.eventNamespace+" blur"+this.eventNamespace,function(){e(this).removeClass("ui-state-active")});this.buttonElement.is("a")&&this.buttonElement.keyup(function(t){t.keyCode===e.ui.keyCode.SPACE&&e(this).click()})}this._setOption("disabled",u.disabled);this._resetButton()},_determineButtonType:function(){var e,t,n;this.element.is("[type=checkbox]")?this.type="checkbox":this.element.is("[type=radio]")?this.type="radio":this.element.is("input")?this.type="input":this.type="button";if(this.type==="checkbox"||this.type==="radio"){e=this.element.parents().last();t="label[for='"+this.element.attr("id")+"']";this.buttonElement=e.find(t);if(!this.buttonElement.length){e=e.length?e.siblings():this.element.siblings();this.buttonElement=e.filter(t);this.buttonElement.length||(this.buttonElement=e.find(t))}this.element.addClass("ui-helper-hidden-accessible");n=this.element.is(":checked");n&&this.buttonElement.addClass("ui-state-active");this.buttonElement.prop("aria-pressed",n)}else this.buttonElement=this.element},widget:function(){return this.buttonElement},_destroy:function(){this.element.removeClass("ui-helper-hidden-accessible");this.buttonElement.removeClass(o+" "+u+" "+a).removeAttr("role").removeAttr("aria-pressed").html(this.buttonElement.find(".ui-button-text").html());this.hasTitle||this.buttonElement.removeAttr("title")},_setOption:function(e,t){this._super(e,t);if(e==="disabled"){t?this.element.prop("disabled",!0):this.element.prop("disabled",!1);return}this._resetButton()},refresh:function(){var t=this.element.is("input, button")?this.element.is(":disabled"):this.element.hasClass("ui-button-disabled");t!==this.options.disabled&&this._setOption("disabled",t);this.type==="radio"?l(this.element[0]).each(function(){e(this).is(":checked")?e(this).jpxbutton("widget").addClass("ui-state-active").attr("aria-pressed","true"):e(this).jpxbutton("widget").removeClass("ui-state-active").attr("aria-pressed","false")}):this.type==="checkbox"&&(this.element.is(":checked")?this.buttonElement.addClass("ui-state-active").attr("aria-pressed","true"):this.buttonElement.removeClass("ui-state-active").attr("aria-pressed","false"))},_resetButton:function(){if(this.type==="input"){this.options.label&&this.element.val(this.options.label);return}var t=this.buttonElement.removeClass(a),n=e("<span></span>",this.document[0]).addClass("ui-button-text").html(this.options.label).appendTo(t.empty()).text(),r=this.options.icons,i=r.primary&&r.secondary,s=[];if(r.primary||r.secondary){this.options.text&&s.push("ui-button-text-icon"+(i?"s":r.primary?"-primary":"-secondary"));r.primary&&t.prepend("<span class='ui-button-icon-primary ui-icon "+r.primary+"'></span>");r.secondary&&t.append("<span class='ui-button-icon-secondary ui-icon "+r.secondary+"'></span>");if(!this.options.text){s.push(i?"ui-button-icons-only":"ui-button-icon-only");this.hasTitle||t.attr("title",e.trim(n))}}else s.push("ui-button-text-only");t.addClass(s.join(" "))}});e.widget("ui.buttonset",{version:"1.10.3",options:{items:"button, input[type=button], input[type=submit], input[type=reset], input[type=checkbox], input[type=radio], a, :data(ui-button)"},_create:function(){this.element.addClass("ui-buttonset")},_init:function(){this.refresh()},_setOption:function(e,t){e==="disabled"&&this.buttons.jpxbutton("option",e,t);this._super(e,t)},refresh:function(){var t=this.element.css("direction")==="rtl";this.buttons=this.element.find(this.options.items).filter(":ui-button").jpxbutton("refresh").end().not(":ui-button").jpxbutton().end().map(function(){return e(this).jpxbutton("widget")[0]}).removeClass("ui-corner-all ui-corner-left ui-corner-right").filter(":first").addClass(t?"ui-corner-right":"ui-corner-left").end().filter(":last").addClass(t?"ui-corner-left":"ui-corner-right").end().end()},_destroy:function(){this.element.removeClass("ui-buttonset");this.buttons.map(function(){return e(this).jpxbutton("widget")[0]}).removeClass("ui-corner-left ui-corner-right").end().jpxbutton("destroy")}})})(jQuery);(function(e,t,n,r){function s(e){return n.translate(e)||e}function u(e){e.html('<div class="plupload_wrapper"><div class="ui-widget-content plupload_container"><div class="ui-state-default ui-widget-header plupload_header"><div class="plupload_header_content"><div class="plupload_logo"> </div><div class="plupload_header_title">'+s("Select files")+"</div>"+'<div class="plupload_header_text">'+s("Add files to the upload queue and click the start button.")+"</div>"+'<div class="plupload_view_switch">'+'<input type="radio" id="plupload_view_list" name="view_mode" checked="checked" /> <label class="plupload_button" for="plupload_view_list">List</label>'+'<input type="radio" id="plupload_view_thumbs" name="view_mode" /> <label class="plupload_button"  for="plupload_view_thumbs">Thumbnails</label>'+"</div>"+"</div>"+"</div>"+'<table class="plupload_filelist plupload_filelist_header ui-widget-header">'+"<tr>"+'<td class="plupload_cell plupload_file_name">'+s("Filename")+"</td>"+'<td class="plupload_cell plupload_file_status">'+s("Status")+"</td>"+'<td class="plupload_cell plupload_file_size">'+s("Size")+"</td>"+'<td class="plupload_cell plupload_file_action">&nbsp;</td>'+"</tr>"+"</table>"+'<div class="plupload_content">'+'<div class="plupload_droptext">'+s("Drag files here.")+"</div>"+'<ul class="plupload_filelist_content"> </ul>'+'<div class="plupload_clearer">&nbsp;</div>'+"</div>"+'<table class="plupload_filelist plupload_filelist_footer ui-widget-header">'+"<tr>"+'<td class="plupload_cell plupload_file_name">'+'<div class="plupload_buttons"><!-- Visible -->'+'<a class="plupload_button plupload_add">'+s("Add Files")+"</a>&nbsp;"+'<a class="plupload_button plupload_start">'+s("Start Upload")+"</a>&nbsp;"+'<a class="plupload_button plupload_stop plupload_hidden">'+s("Stop Upload")+"</a>&nbsp;"+"</div>"+'<div class="plupload_started plupload_hidden"><!-- Hidden -->'+'<div class="plupload_progress plupload_right">'+'<div class="plupload_progress_container"></div>'+"</div>"+'<div class="plupload_cell plupload_upload_status"></div>'+'<div class="plupload_clearer">&nbsp;</div>'+"</div>"+"</td>"+'<td class="plupload_file_status"><span class="plupload_total_status">0%</span></td>'+'<td class="plupload_file_size"><span class="plupload_total_file_size">0 kb</span></td>'+'<td class="plupload_file_action"></td>'+"</tr>"+"</table>"+"</div>"+'<input class="plupload_count" value="0" type="hidden">'+"</div>")}var i={};r.widget("ui.plupload",{widgetEventPrefix:"",imgs:{},contents_bak:"",options:{browse_button_hover:"ui-state-hover",browse_button_active:"ui-state-active",dragdrop:!0,multiple_queues:!0,buttons:{browse:!0,start:!0,stop:!0},views:{list:!0,thumbs:!1,active:"list",remember:!0},autostart:!1,sortable:!1,rename:!1,max_file_count:0},FILE_COUNT_ERROR:-9001,_create:function(){var e=this.element.attr("id");if(!e){e=n.guid();this.element.attr("id",e)}this.id=e;this.contents_bak=this.element.html();u(this.element);this.container=r(".plupload_container",this.element).attr("id",e+"_container");this.content=r(".plupload_content",this.element);r.fn.resizable&&this.container.resizable({handles:"s",minHeight:300});this.filelist=r(".plupload_filelist_content",this.container).attr({id:e+"_filelist",unselectable:"on"});this.browse_button=r(".plupload_add",this.container).attr("id",e+"_browse");this.start_button=r(".plupload_start",this.container).attr("id",e+"_start");this.stop_button=r(".plupload_stop",this.container).attr("id",e+"_stop");if(r.ui.jpxbutton){this.browse_button.jpxbutton({icons:{primary:"ui-icon-circle-plus"},disabled:!0});this.start_button.jpxbutton({icons:{primary:"ui-icon-circle-arrow-e"},disabled:!0});this.stop_button.jpxbutton({icons:{primary:"ui-icon-circle-close"}})}this.progressbar=r(".plupload_progress_container",this.container);r.ui.progressbar&&this.progressbar.progressbar();this.counter=r(".plupload_count",this.element).attr({id:e+"_count",name:e+"_count"});this._initUploader()},_initUploader:function(){var e=this,t=this.id,u,a={container:t+"_buttons",browse_button:t+"_browse"};r(".plupload_buttons",this.element).attr("id",t+"_buttons");if(e.options.dragdrop){this.filelist.parent().attr("id",this.id+"_dropbox");a.drop_element=this.id+"_dropbox"}e.options.views.thumbs&&(o.typeOf(e.options.required_features)==="string"?e.options.required_features+=",display_media":e.options.required_features="display_media");u=this.uploader=i[t]=new n.Uploader(r.extend(this.options,a));u.bind("Error",function(t,r){r.code===n.INIT_ERROR&&e.destroy()});u.bind("PostInit",function(t){if(!e.options.buttons.browse){e.browse_button.jpxbutton("disable").hide();t.disableBrowse(!0)}else e.browse_button.jpxbutton("enable");e.options.buttons.start||e.start_button.jpxbutton("disable").hide();e.options.buttons.stop||e.stop_button.jpxbutton("disable").hide();!e.options.unique_names&&e.options.rename&&e._enableRenaming();e.options.dragdrop&&t.features.dragdrop&&e.filelist.parent().addClass("plupload_dropbox");e._enableViewSwitcher();e.start_button.click(function(t){r(this).jpxbutton("option","disabled")||e.start();t.preventDefault()});e.stop_button.click(function(t){e.stop();t.preventDefault()});e._trigger("ready",null,{up:t})});if(e.options.max_file_count){e.options.multiple_queues=!1;u.bind("FilesAdded",function(t,n){var r=[],i=n.length,o=t.files.length+i-e.options.max_file_count;if(o>0){r=n.splice(i-o,o);t.trigger("Error",{code:e.FILE_COUNT_ERROR,message:s("File count error."),file:r})}})}u.init();u.bind("FilesAdded",function(t,n){e._addFiles(n);e._trigger("selected",null,{up:t,files:n});e.options.autostart&&setTimeout(function(){e.start()},10)});u.bind("FilesRemoved",function(t,n){e._trigger("removed",null,{up:t,files:n})});u.bind("QueueChanged",function(){e._updateTotalProgress()});u.bind("StateChanged",function(){e._handleState()});u.bind("UploadFile",function(t,n){e._handleFileStatus(n)});u.bind("FileUploaded",function(t,n){e._handleFileStatus(n);e._trigger("uploaded",null,{up:t,file:n})});u.bind("UploadProgress",function(t,n){e._handleFileStatus(n);e._updateTotalProgress();e._trigger("progress",null,{up:t,file:n})});u.bind("UploadComplete",function(t,n){e._trigger("complete",null,{up:t,files:n})});u.bind("Error",function(t,r){var i=r.file,o,u;if(i){o="<strong>"+r.message+"</strong>";u=r.details;if(u)o+=" <br /><i>"+r.details+"</i>";else{switch(r.code){case n.FILE_EXTENSION_ERROR:u=s("File: %s").replace("%s",i.name);break;case n.FILE_SIZE_ERROR:u=s("File: %f, size: %s, max file size: %m").replace(/%([fsm])/g,function(t,r){switch(r){case"f":return i.name;case"s":return i.size;case"m":return n.parseSize(e.options.max_file_size)}});break;case n.FILE_DUPLICATE_ERROR:u=s("%s already present in the queue.").replace(/%s/,i.name);break;case e.FILE_COUNT_ERROR:u=s("Upload element accepts only %d file(s) at a time. Extra files were stripped.").replace("%d",e.options.max_file_count);break;case n.IMAGE_FORMAT_ERROR:u=s("Image format either wrong or not supported.");break;case n.IMAGE_MEMORY_ERROR:u=s("Runtime ran out of available memory.");break;case n.HTTP_ERROR:u=s("Upload URL might be wrong or doesn't exist.")}o+=" <br /><i>"+u+"</i>"}e.notify("error",o);e._trigger("error",null,{up:t,error:o,file:i})}})},_setOption:function(e,t){var n=this;if(e=="buttons"&&typeof t=="object"){t=r.extend(n.options.buttons,t);if(!t.browse){n.browse_button.jpxbutton("disable").hide();n.uploader.disableBrowse(!0)}else{n.browse_button.jpxbutton("enable").show();n.uploader.disableBrowse(!1)}t.start?n.start_button.jpxbutton("enable").show():n.start_button.jpxbutton("disable").hide();t.stop?n.start_button.jpxbutton("enable").show():n.stop_button.jpxbutton("disable").hide()}n.uploader.settings[e]=t},start:function(){this.uploader.start();this._trigger("start",null,{up:this.uploader})},stop:function(){this.uploader.stop();this._trigger("stop",null,{up:this.uploader})},enable:function(){this.browse_button.jpxbutton("enable");this.uploader.disableBrowse(!1)},disable:function(){this.browse_button.jpxbutton("disable");this.uploader.disableBrowse(!0)},getFile:function(e){var t;typeof e=="number"?t=this.uploader.files[e]:t=this.uploader.getFile(e);return t},getFiles:function(){return this.uploader.files},removeFile:function(e){n.typeOf(e)==="string"&&(e=this.getFile(e));this._removeFiles(e)},clearQueue:function(){this.uploader.splice()},getUploader:function(){return this.uploader},notify:function(e,t){var n=r('<div class="plupload_message"><span class="plupload_message_close ui-icon ui-icon-circle-close" title="'+s("Close")+'"></span>'+'<p><span class="ui-icon"></span>'+t+"</p>"+"</div>");n.addClass("ui-state-"+(e==="error"?"error":"highlight")).find("p .ui-icon").addClass("ui-icon-"+(e==="error"?"alert":"info")).end().find(".plupload_message_close").click(function(){n.remove()}).end();r(".plupload_header",this.container).append(n)},destroy:function(){this._removeFiles([].slice.call(this.uploader.files));this.uploader.destroy();r(".plupload_button",this.element).unbind();r.ui.jpxbutton&&r(".plupload_add, .plupload_start, .plupload_stop",this.container).jpxbutton("destroy");r.ui.progressbar&&this.progressbar.progressbar("destroy");r.ui.sortable&&this.options.sortable&&r("tbody",this.filelist).sortable("destroy");this.element.empty().html(this.contents_bak);this.contents_bak="";r.Widget.prototype.destroy.apply(this)},_handleState:function(){var e=this,t=this.uploader;if(t.state===n.STARTED){r(e.start_button).jpxbutton("disable");r([]).add(e.stop_button).add(".plupload_started").removeClass("plupload_hidden");r(".plupload_upload_status",e.element).html(s("Uploaded %d/%d files").replace("%d/%d",t.total.uploaded+"/"+t.files.length));r(".plupload_header_content",e.element).addClass("plupload_header_content_bw")}else{r([]).add(e.stop_button).add(".plupload_started").addClass("plupload_hidden");if(e.options.multiple_queues){r(e.start_button).jpxbutton("enable");r(".plupload_header_content",e.element).removeClass("plupload_header_content_bw")}e._updateTotalProgress()}},_handleFileStatus:function(e){function o(){var i="",s=parseInt(t.counter.val()||0,10),o=t.id+"_"+s;e.target_name&&(i+='<input type="hidden" name="'+o+'_tmpname" value="'+n.xmlEncode(e.target_name)+'" />');i+='<input type="hidden" name="'+o+'_name" value="'+n.xmlEncode(e.name)+'" />';i+='<input type="hidden" name="'+o+'_status" value="'+(e.status===n.DONE?"done":"failed")+'" />';r("#"+e.id).find(".plupload_file_fields").html(i);t.counter.val(++s)}var t=this,i,s;if(!r("#"+e.id).length)return;switch(e.status){case n.DONE:i="plupload_done";s="ui-icon ui-icon-circle-check";o();break;case n.FAILED:i="ui-state-error plupload_failed";s="ui-icon ui-icon-alert";o();break;case n.QUEUED:i="plupload_delete";s="ui-icon ui-icon-circle-minus";break;case n.UPLOADING:i="ui-state-highlight plupload_uploading";s="ui-icon ui-icon-circle-arrow-w";var u=r(".plupload_scroll",this.container),a=u.scrollTop(),f=u.height(),l=r("#"+e.id).position().top+r("#"+e.id).height();f<l&&u.scrollTop(a+l-f);r("#"+e.id).find(".plupload_file_percent").html(e.percent+"%").end().find(".plupload_file_progress").css("width",e.percent+"%").end().find(".plupload_file_size").html(n.formatSize(e.size))}i+=" ui-state-default plupload_file";r("#"+e.id).attr("class",i).find(".ui-icon").attr("class",s).end().filter(".plupload_delete, .plupload_done").find(".ui-icon").click(function(n){t._removeFiles(e);n.preventDefault()})},_updateTotalProgress:function(){var e=this.uploader;e.total.queued===0?r(".ui-button-text",this.browse_button).html(s("Add Files")):r(".ui-button-text",this.browse_button).html(s("%d files queued").replace("%d",e.total.queued));e.refresh();e.files.length===e.total.uploaded+e.total.failed?this.start_button.jpxbutton("disable"):this.start_button.jpxbutton("enable");this.filelist[0].scrollTop=this.filelist[0].scrollHeight;this.progressbar.progressbar("value",e.total.percent);this.element.find(".plupload_total_status").html(e.total.percent+"%").end().find(".plupload_total_file_size").html(n.formatSize(e.total.size)).end().find(".plupload_upload_status").html(s("Uploaded %d/%d files").replace("%d/%d",e.total.uploaded+"/"+e.files.length))},_addFiles:function(e){var t=this,i,s=[];i='<li class="plupload_file ui-state-default" id="%id%"><div class="plupload_file_thumb"> </div><div class="plupload_file_name" title="%name%"><span class="plupload_file_namespan">%name%</span></div><div class="plupload_file_action"><div class="ui-icon"> </div></div><div class="plupload_file_size">%size% </div><div class="plupload_file_status"><div class="plupload_file_progress ui-widget-header" style="width: 0%"> </div><span class="plupload_file_percent">%percent% </span></div><div class="plupload_clear plupload_file_fields"> </div></li>';n.typeOf(e)!=="array"&&(e=[e]);r.ui.sortable&&this.options.sortable&&r("tbody",t.filelist).sortable("destroy");r.each(e,function(e,u){t.filelist.append(i.replace(/%(\w+)%/g,function(e,t){return"size"===t?n.formatSize(u.size):u[t]||""}));t.options.views.thumbs&&s.push(function(e){var n=new o.Image;n.onload=function(){n.embed(r("#"+u.id+" .plupload_file_thumb",t.filelist)[0],{width:100,height:60,crop:!0,swf_url:mOxie.resolveUrl(t.options.flash_swf_url),xap_url:mOxie.resolveUrl(t.options.silverlight_xap_url)});setTimeout(e,1)};n.onembedded=function(){n.destroy()};n.onerror=function(){var i=u.name.match(/\.([^\.]{1,7})$/);r("#"+u.id+" .plupload_file_thumb",t.filelist).html('<div class="plupload_file_dummy ui-widget-content"><span class="ui-state-disabled">'+(i?i[1]:"none")+"</span></div>");n.destroy();e()};n.load(u.getSource())});t._handleFileStatus(u)});s.length&&o.inSeries(s);this.options.sortable&&r.ui.sortable&&this._enableSortingList();this._trigger("updatelist",null,{filelist:this.filelist})},_removeFiles:function(e){var t=this,i=this.uploader;n.typeOf(e)!=="array"&&(e=[e]);r.ui.sortable&&this.options.sortable&&r("tbody",t.filelist).sortable("destroy");r.each(e,function(e,t){if(t.imgs&&t.imgs.length){r.each(t.imgs,function(e,t){t.destroy()});t.imgs=[]}r("#"+t.id).remove();i.removeFile(t)});i.files.length&&this.options.sortable&&r.ui.sortable&&this._enableSortingList();this._trigger("updatelist",null,{filelist:this.filelist})},_viewChanged:function(e){this.options.views.remember&&r.cookie&&r.cookie("plupload_ui_view",e,{expires:7,path:"/"});mOxie.Env.browser==="IE"&&mOxie.Env.version<7&&this.content.attr("style",'height:expression(document.getElementById("'+this.id+"_container"+'").clientHeight - '+(e==="list"?133:103)+");");this.container.removeClass("plupload_view_list plupload_view_thumbs").addClass("plupload_view_"+e);this.view_mode=e;this._trigger("viewchanged",null,{view:e})},_enableViewSwitcher:function(){var e=this,t,i=r(".plupload_view_switch",this.container),s,o;n.each(["list","thumbs"],function(t){e.options.views[t]||i.find('[for="plupload_view_'+t+'"], #plupload_view_'+t).remove()});s=i.find(".plupload_button");if(s.length===1){i.hide();t=s.attr("for").replace(/^plupload_view_/,"");this._viewChanged(t);return}if(!(r.ui.jpxbutton&&s.length>1)){i.show();this._viewChanged(this.options.views.active);return}i.show();i.buttonset();i.find(".plupload_button").click(function(){t=r(this).attr("for").replace(/^plupload_view_/,"");e._viewChanged(t)});this.options.views.remember&&r.cookie&&(t=r.cookie("plupload_ui_view"));~n.inArray(t,["list","thumbs"])||(t=this.options.views.active);o=i.find('[for="plupload_view_'+t+'"]');if(o.length){o.trigger("click");return}},_enableRenaming:function(){var e=this;this.filelist.dblclick(function(t){var n=r(t.target),i,s,o,u,a="";if(!n.hasClass("plupload_file_namespan"))return;s=e.uploader.getFile(n.closest(".plupload_file")[0].id);u=s.name;o=/^(.+)(\.[^.]+)$/.exec(u);if(o){u=o[1];a=o[2]}i=r('<input class="plupload_file_rename" type="text" />').width(n.width()).insertAfter(n.hide());i.val(u).blur(function(){n.show().parent().scrollLeft(0).end().next().remove()}).keydown(function(e){var t=r(this);if(r.inArray(e.keyCode,[13,27])!==-1){e.preventDefault();if(e.keyCode===13){s.name=t.val()+a;n.html(s.name)}t.blur()}})[0].focus()})},_enableSortingList:function(){var e=this,t=r(".plupload_filelist_content",this.element);if(r(".plupload_file",t).length<2)return;t.sortable({items:".plupload_delete",cancel:"object, .plupload_clearer",stop:function(){var t=[];r.each(r(this).sortable("toArray"),function(n,r){t[t.length]=e.uploader.getFile(r)});t.unshift(t.length);t.unshift(0);Array.prototype.splice.apply(e.uploader.files,t)}})}})})(window,document,plupload,jQuery);